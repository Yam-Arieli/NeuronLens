<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NeuronLens — Neural Network Visualizer</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMiAzMiI+PHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNiIgZmlsbD0iIzBkMTExNyIvPjxjaXJjbGUgY3g9IjciIGN5PSI5IiByPSIyLjUiIGZpbGw9IiM1OGE2ZmYiLz48Y2lyY2xlIGN4PSI3IiBjeT0iMTYiIHI9IjIuNSIgZmlsbD0iIzU4YTZmZiIvPjxjaXJjbGUgY3g9IjciIGN5PSIyMyIgcj0iMi41IiBmaWxsPSIjNThhNmZmIi8+PGNpcmNsZSBjeD0iMTYiIGN5PSIxMiIgcj0iMi41IiBmaWxsPSIjNThhNmZmIiBvcGFjaXR5PSIuNzUiLz48Y2lyY2xlIGN4PSIxNiIgY3k9IjIwIiByPSIyLjUiIGZpbGw9IiM1OGE2ZmYiIG9wYWNpdHk9Ii43NSIvPjxjaXJjbGUgY3g9IjI1IiBjeT0iMTYiIHI9IjIuNSIgZmlsbD0iIzU4YTZmZiIgb3BhY2l0eT0iLjUiLz48bGluZSB4MT0iOS41IiB5MT0iOSIgeDI9IjEzLjUiIHkyPSIxMiIgc3Ryb2tlPSIjNThhNmZmIiBzdHJva2Utd2lkdGg9Ii44IiBvcGFjaXR5PSIuMyIvPjxsaW5lIHgxPSI5LjUiIHkxPSIxNiIgeDI9IjEzLjUiIHkyPSIxMiIgc3Ryb2tlPSIjNThhNmZmIiBzdHJva2Utd2lkdGg9Ii44IiBvcGFjaXR5PSIuMyIvPjxsaW5lIHgxPSI5LjUiIHkxPSIyMyIgeDI9IjEzLjUiIHkyPSIxMiIgc3Ryb2tlPSIjNThhNmZmIiBzdHJva2Utd2lkdGg9Ii44IiBvcGFjaXR5PSIuMyIvPjxsaW5lIHgxPSI5LjUiIHkxPSI5IiB4Mj0iMTMuNSIgeTI9IjIwIiBzdHJva2U9IiM1OGE2ZmYiIHN0cm9rZS13aWR0aD0iLjgiIG9wYWNpdHk9Ii4zIi8+PGxpbmUgeDE9IjkuNSIgeTE9IjE2IiB4Mj0iMTMuNSIgeTI9IjIwIiBzdHJva2U9IiM1OGE2ZmYiIHN0cm9rZS13aWR0aD0iLjgiIG9wYWNpdHk9Ii4zIi8+PGxpbmUgeDE9IjkuNSIgeTE9IjIzIiB4Mj0iMTMuNSIgeTI9IjIwIiBzdHJva2U9IiM1OGE2ZmYiIHN0cm9rZS13aWR0aD0iLjgiIG9wYWNpdHk9Ii4zIi8+PGxpbmUgeDE9IjE4LjUiIHkxPSIxMiIgeDI9IjIyLjUiIHkyPSIxNiIgc3Ryb2tlPSIjNThhNmZmIiBzdHJva2Utd2lkdGg9Ii44IiBvcGFjaXR5PSIuMyIvPjxsaW5lIHgxPSIxOC41IiB5MT0iMjAiIHgyPSIyMi41IiB5Mj0iMTYiIHN0cm9rZT0iIzU4YTZmZiIgc3Ryb2tlLXdpZHRoPSIuOCIgb3BhY2l0eT0iLjMiLz48L3N2Zz4=">
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  background: #0d1117;
  color: #e6edf3;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", monospace;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

#app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

/* ── Top toolbar ─────────────────────────────────────────── */
#toolbar {
  flex: 0 0 auto;
  background: #161b22;
  border-bottom: 1px solid #30363d;
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
}

#toolbar h1 {
  font-size: 15px;
  font-weight: 600;
  color: #58a6ff;
  margin-right: 8px;
  white-space: nowrap;
}

.filter-group {
  display: flex;
  align-items: center;
  gap: 6px;
  background: #0d1117;
  border: 1px solid #30363d;
  border-radius: 6px;
  padding: 4px 10px;
}

.filter-group label {
  font-size: 12px;
  color: #8b949e;
  white-space: nowrap;
}

.filter-group select,
.filter-group input[type="text"] {
  background: #0d1117;
  border: none;
  color: #e6edf3;
  font-size: 12px;
  outline: none;
  min-width: 80px;
}

.color-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}

.btn {
  background: #21262d;
  border: 1px solid #30363d;
  border-radius: 6px;
  color: #e6edf3;
  cursor: pointer;
  font-size: 12px;
  padding: 4px 12px;
  transition: background 0.15s;
}

.btn:hover {
  background: #30363d;
}

.btn.active {
  background: #1f6feb;
  border-color: #388bfd;
}

#status-bar {
  font-size: 11px;
  color: #8b949e;
  margin-left: auto;
  white-space: nowrap;
}

/* ── Canvas area ─────────────────────────────────────────── */
#canvas-container {
  flex: 1 1 auto;
  overflow: hidden;
  position: relative;
}

#main-canvas {
  display: block;
  cursor: default;
}

/* ── Tooltip ─────────────────────────────────────────────── */
#tooltip {
  position: fixed;
  background: #161b22;
  border: 1px solid #30363d;
  border-radius: 6px;
  padding: 8px 12px;
  font-size: 12px;
  pointer-events: none;
  display: none;
  z-index: 100;
  max-width: 260px;
  line-height: 1.5;
}

#tooltip .tt-title {
  font-weight: 600;
  color: #58a6ff;
  margin-bottom: 4px;
}

#tooltip .tt-row {
  display: flex;
  justify-content: space-between;
  gap: 12px;
}

#tooltip .tt-label {
  color: #8b949e;
}

#tooltip .tt-val {
  color: #e6edf3;
  font-family: monospace;
}

/* ── Legend ──────────────────────────────────────────────── */
#legend {
  flex: 0 0 auto;
  background: #161b22;
  border-top: 1px solid #30363d;
  padding: 6px 16px;
  font-size: 11px;
  color: #8b949e;
  display: flex;
  gap: 20px;
  align-items: center;
}

</style>
</head>
<body>
<div id="app">
  <div id="toolbar">
    <h1>NeuronLens</h1>

    <!-- Mode toggles -->
    <button class="btn active" id="btn-single">Single filter</button>
    <button class="btn" id="btn-compare">Compare</button>

    <!-- Filter A -->
    <div class="filter-group" id="single-row">
      <span class="color-dot" style="background:#58a6ff"></span>
      <label>Filter:</label>
      <select id="filter-a"></select>
    </div>

    <!-- Filter B (compare mode only) -->
    <div class="filter-group" id="compare-row" style="display:none">
      <span class="color-dot" style="background:#ff6464"></span>
      <label>Compare:</label>
      <select id="filter-b"></select>
    </div>

    <span id="status-bar"></span>
  </div>

  <div id="canvas-container">
    <canvas id="main-canvas"></canvas>
  </div>

  <div id="legend">
    <span>Brightness ∝ activation magnitude</span>
    <span>·</span>
    <span>Edge thickness ∝ |weight|</span>
    <span>·</span>
    <span>Hover neuron to isolate edges</span>
  </div>
</div>

<div id="tooltip"></div>

<script>
const __NETWORK__ = {"layers":[{"name":"input","type":"input","block_label":"Input","block_type":"input","n_neurons":6,"aggregated":false,"bucket_size":1,"n_display_units":6,"perm":[3,4,2,0,1,5]},{"name":"0","type":"linear","block_label":"Linear(6\u219232) \u00b7 BatchNorm1d \u00b7 ReLU","block_type":"linear+norm+activation","n_neurons":32,"aggregated":false,"bucket_size":1,"n_display_units":32,"perm":[5,4,12,13,15,17,18,9,20,21,23,25,19,2,16,3,29,22,11,27,24,10,1,14,0,7,31,28,6,26,8,30]},{"name":"3","type":"linear","block_label":"Linear(32\u219216) \u00b7 ReLU","block_type":"linear+activation","n_neurons":16,"aggregated":false,"bucket_size":1,"n_display_units":16,"perm":[3,1,12,10,2,15,9,6,4,11,13,5,8,7,0,14]},{"name":"5","type":"linear","block_label":"Linear(16\u21928) \u00b7 ReLU","block_type":"linear+activation","n_neurons":8,"aggregated":false,"bucket_size":1,"n_display_units":8,"perm":[3,4,0,6,1,5,7,2]},{"name":"7","type":"linear","block_label":"Linear(8\u21921)","block_type":"linear","n_neurons":1,"aggregated":false,"bucket_size":1,"n_display_units":1,"perm":[0]}],"edges":[[[0.06192301958799362,-0.2985140383243561,0.07218904793262482,0.2508380115032196,-0.3014741837978363,0.27153706550598145,0.3231813311576843,-0.46687236428260803,-0.006963855586946011,-0.18457871675491333,0.337597131729126,0.32867148518562317,0.06786425411701202,0.1577969342470169,-0.2169678807258606,-0.23131082952022552,0.2058607041835785,-0.11486566811800003,-0.3196093440055847,0.3080551028251648,-0.0322682149708271,0.22362782061100006,0.17294010519981384,-0.06944125145673752,-0.1332404762506485,-0.035309575498104095,-0.34910041093826294,0.12103132903575897,-0.13111966848373413,-0.08548888564109802,0.22719280421733856,-0.0933019369840622],[0.04394765570759773,0.16522005200386047,-0.06542779505252838,0.2912534773349762,0.16523516178131104,0.1944618821144104,0.3033064603805542,0.11462395638227463,0.0210181325674057,-0.4617052972316742,-0.4761461913585663,-0.0849776566028595,0.2483164519071579,0.28442153334617615,-0.3001759350299835,-0.4111253619194031,0.23833495378494263,-0.17454572021961212,0.20080849528312683,-0.29422497749328613,0.177913635969162,0.35285118222236633,0.11818519234657288,0.351462185382843,-0.20096629858016968,0.16576950252056122,0.2885872423648834,-0.3413279950618744,0.3381693661212921,0.11580249667167664,-0.22541303932666779,0.033190734684467316],[0.22609083354473114,0.3514307737350464,0.1353631615638733,0.1520635038614273,0.14176765084266663,0.13817578554153442,0.35059255361557007,0.289579838514328,0.25644052028656006,0.04568988084793091,-0.38717103004455566,0.07599914073944092,-0.3398520052433014,-0.1560482680797577,-0.3739267885684967,0.22888413071632385,-0.32023885846138,-0.21904578804969788,0.4427919387817383,0.08650325983762741,0.24291789531707764,0.08994868397712708,0.034721799194812775,-0.4239986538887024,0.039490729570388794,-0.3100835084915161,0.024811062961816788,0.27938520908355713,-0.3656570315361023,0.08518899977207184,0.10234483331441879,-0.12561365962028503],[0.15757814049720764,0.3307183086872101,0.16114595532417297,0.32534870505332947,-0.043788548558950424,0.31282374262809753,0.3313741385936737,-0.07310876995325089,-0.10146550834178925,0.24432022869586945,-0.26861944794654846,0.39400702714920044,0.3344392776489258,-0.048961494117975235,0.0646296888589859,-0.03369169309735298,-0.0012808891478925943,-0.2820732891559601,0.045039162039756775,-0.15326111018657684,-0.31848788261413574,-0.39447227120399475,0.0067036510445177555,-0.05114920809864998,-0.4171503186225891,-0.33918383717536926,-0.4194681942462921,-0.1354406774044037,-0.4242963194847107,-0.07269513607025146,-0.11249470710754395,-0.33465513586997986],[-0.34453991055488586,-0.425309956073761,-0.41748154163360596,-0.3011595904827118,-0.3336406350135803,-0.04924684762954712,-0.0982849970459938,-0.3134896755218506,-0.14681807160377502,-0.18825876712799072,-0.24315793812274933,0.1903228461742401,-0.15092068910598755,-0.02747909352183342,0.12771424651145935,0.007031282410025597,0.11677192151546478,-0.22047469019889832,0.3031917214393616,0.11714007705450058,-0.15728428959846497,0.10414516180753708,0.19728808104991913,0.36542031168937683,0.13411632180213928,0.09960272908210754,0.25316086411476135,0.3681970536708832,0.22907647490501404,0.4220666289329529,0.3864762485027313,0.2605295777320862],[-0.28298911452293396,0.02315359003841877,-0.010842151008546352,-0.06384246796369553,-0.40401750802993774,-0.061923686414957047,0.057700950652360916,-0.05569996312260628,-0.39560192823410034,0.268265038728714,-0.11057738959789276,-0.25946521759033203,0.29519006609916687,-0.32775914669036865,-0.04491538926959038,0.17025820910930634,-0.26904284954071045,0.16285160183906555,-0.3466383218765259,-0.27895209193229675,0.3006708025932312,0.2977484464645386,0.3204403519630432,0.00880398228764534,0.23900608718395233,0.19996115565299988,0.07332184165716171,0.12478523701429367,0.18556992709636688,-0.05992234870791435,0.08589388430118561,-0.10417632758617401]],[[0.20329464972019196,0.18079376220703125,0.08202394843101501,0.19835245609283447,0.12307198345661163,-0.021164968609809875,0.1297910362482071,-0.058612316846847534,0.11439255625009537,0.21767958998680115,0.07536301761865616,0.008577738888561726,0.1291988492012024,-0.10978373885154724,-0.10965452343225479,0.11090589314699173],[0.12147780507802963,0.18800999224185944,0.20893754065036774,0.04983057454228401,0.0433109775185585,0.20390012860298157,0.09885326027870178,0.06075352057814598,0.14763882756233215,0.053145259618759155,-0.05308644846081734,0.12053006887435913,-0.15345264971256256,-0.0618114210665226,-0.10590474307537079,0.07882792502641678],[-0.06514566391706467,0.1825120449066162,0.21238988637924194,0.15697723627090454,0.03157384693622589,0.11694524437189102,0.026917625218629837,-0.080746591091156,0.2276974320411682,0.17593175172805786,-0.04100048169493675,-0.19292515516281128,0.1381329745054245,-0.13301479816436768,-0.19674907624721527,-0.049396686255931854],[0.06535335630178452,0.046103693544864655,0.15962167084217072,0.20876257121562958,0.21837593615055084,-0.025922276079654694,0.026164734736084938,0.03592944145202637,0.1109713688492775,0.20567631721496582,0.21234622597694397,-0.03212333098053932,-0.0856715738773346,-0.17909546196460724,0.026302706450223923,-0.09338855743408203],[0.10065920650959015,0.14701761305332184,-0.07398354262113571,0.10810301452875137,0.22867779433727264,0.18524478375911713,0.13369698822498322,0.24416238069534302,-0.01665300503373146,0.0792449563741684,-0.15922974050045013,0.0026522844564169645,0.05850796774029732,0.07936087250709534,-0.039608076214790344,-0.12089364975690842],[0.09194110333919525,-0.04800321161746979,0.19869855046272278,0.09970565140247345,0.17777316272258759,0.05626072734594345,0.18885906040668488,0.1924315243959427,-0.0001262921723537147,-0.06036628782749176,0.1792445033788681,0.13797059655189514,-0.05139283090829849,-0.04373576119542122,0.03324402496218681,-0.13032355904579163],[0.15311674773693085,0.18356885015964508,-0.003690172918140888,0.16508090496063232,-0.0522436797618866,0.22505433857440948,0.18173520267009735,0.16899655759334564,0.2501755356788635,0.07535097002983093,0.0002707834355533123,-0.006635440979152918,0.0895504504442215,0.14055927097797394,-0.19093316793441772,-0.06371977180242538],[-0.025037044659256935,0.10001400858163834,0.16817663609981537,0.09096775949001312,0.06818185746669769,0.17063677310943604,-0.09501320123672485,0.09557291865348816,0.020594028756022453,0.15918858349323273,-0.05264703556895256,0.1465889811515808,-0.08441208302974701,0.14508873224258423,0.0586235448718071,-0.1594347208738327],[0.211697518825531,0.14087602496147156,0.19523847103118896,0.2159915715456009,-0.05575346574187279,0.22718021273612976,0.16484613716602325,-0.04208669438958168,-0.10059297829866409,0.08160977810621262,-0.09012995660305023,0.047061655670404434,0.023123320192098618,-0.13976965844631195,-0.040171071887016296,-0.11560166627168655],[0.18687790632247925,0.11657494306564331,-0.0758591890335083,0.16116122901439667,0.1899232715368271,0.11949261277914047,0.21261173486709595,0.1389853060245514,0.11995867639780045,-0.08649162948131561,0.031027287244796753,0.001436065067537129,0.05989513918757439,0.015959301963448524,0.10976922512054443,0.0590585432946682],[-0.11492682248353958,-0.03030993416905403,0.061032459139823914,0.046437185257673264,-0.06928722560405731,0.19228844344615936,-0.03770767152309418,0.023521099239587784,0.15912428498268127,0.24729977548122406,0.1392127275466919,-0.08219794929027557,-0.14852328598499298,-0.07824449986219406,0.018194714561104774,-0.008149871602654457],[0.0381549708545208,0.23860418796539307,-0.09299389272928238,0.09273472428321838,-0.0551237091422081,0.14890556037425995,0.21736663579940796,0.09548310190439224,0.21326318383216858,-0.048635516315698624,0.10636019706726074,-0.13360460102558136,0.03751736134290695,-0.052938006818294525,0.11143579334020615,0.0815129205584526],[-0.010304026305675507,0.13106189668178558,0.02998649887740612,0.20862449705600739,-0.11075952649116516,0.15859906375408173,0.11658280342817307,-0.09343724697828293,0.06855934858322144,0.12114744633436203,-0.0405232273042202,0.09030624479055405,-0.08732138574123383,0.15433625876903534,0.2574579417705536,0.14519621431827545],[0.05364373326301575,0.11063537001609802,-0.08737100660800934,-0.060931991785764694,-0.014404887333512306,0.09474500268697739,-0.06184246018528938,-0.013577168807387352,-0.08412238210439682,-0.1655421257019043,0.15382173657417297,0.02902231551706791,0.14104855060577393,-0.14349651336669922,0.10637015849351883,0.13064928352832794],[0.12185139954090118,-0.02759753167629242,-0.0063428208231925964,-0.06517000496387482,0.19032412767410278,-0.07359329611063004,-0.08996790647506714,0.0676780566573143,0.181942418217659,0.16254140436649323,0.07070913165807724,0.18794125318527222,0.07135917246341705,-0.06054411083459854,0.052075229585170746,-0.00615125335752964],[-0.14597958326339722,0.09206157177686691,-0.09356314688920975,-0.002667754888534546,-0.10417433083057404,-0.02805274724960327,-0.006874443963170052,0.02235949970781803,0.1855054348707199,0.05547061190009117,0.2184154987335205,0.09455667436122894,0.040392063558101654,0.15747688710689545,0.004357767291367054,0.07041306048631668],[0.01711072027683258,-0.18348203599452972,0.16905111074447632,-0.056354403495788574,-0.15964306890964508,-0.08875889331102371,0.07755012810230255,0.11754333227872849,0.05832698941230774,-0.06749933958053589,0.2621837854385376,0.02555740438401699,0.14970581233501434,-0.1699008345603943,-0.12092436105012894,-0.00327720632776618],[-0.05945639684796333,0.02545349858701229,-0.014941285364329815,-0.051192812621593475,0.18155640363693237,0.03946289047598839,0.11642096936702728,0.24567393958568573,-0.12032327800989151,-0.06289372593164444,-0.08863815665245056,0.12965475022792816,0.116482675075531,0.11969739198684692,-0.007292211055755615,0.12046323716640472],[0.1298072636127472,-0.04059856757521629,-0.13078466057777405,0.050793539732694626,0.12070882320404053,0.04646208509802818,-0.025395287200808525,-0.08435877412557602,-0.029769480228424072,0.0915829986333847,0.004790313541889191,0.18705470860004425,-0.06982020288705826,-0.05205659195780754,-0.016286242753267288,0.056750524789094925],[-0.09275342524051666,-0.23953333497047424,0.18063917756080627,-0.016032477840781212,0.04510881379246712,0.17650531232357025,-0.06202215701341629,0.067888543009758,0.06302307546138763,0.22527377307415009,0.18794429302215576,-0.09400525689125061,-0.037771038711071014,-0.011912830173969269,0.1599203646183014,-0.09166159480810165],[0.14006097614765167,-0.09293560683727264,-0.0827254056930542,0.10403142124414444,0.2589337229728699,0.06908614933490753,0.036477070301771164,0.1820065677165985,0.11144580692052841,0.17584586143493652,0.09038902074098587,0.12665918469429016,0.16788281500339508,0.1266832798719406,0.188322514295578,0.19368433952331543],[0.02989978902041912,0.07551870495080948,0.09915736317634583,0.11902562528848648,-0.1723882555961609,0.051746666431427,-0.016510749235749245,-0.14544972777366638,-0.10308678448200226,0.04985490068793297,0.2653886675834656,0.1899598389863968,-0.11331897974014282,0.1775972843170166,0.11985531449317932,0.011324609629809856],[0.005676242057234049,-0.08620712906122208,0.17813736200332642,-0.017975464463233948,0.09263823181390762,0.0655013844370842,0.035425543785095215,0.0787474736571312,-0.0111613180488348,0.08693281561136246,0.004164878278970718,0.20025211572647095,-0.06999128311872482,0.1443813294172287,-0.14433036744594574,0.014817844144999981],[-0.1049923300743103,-0.02136904187500477,0.07391511648893356,-0.0049468451179564,-0.08058162033557892,-0.08348775655031204,0.09013857692480087,-0.09407557547092438,0.021568292751908302,-0.05951884388923645,0.1724705696105957,0.11521660536527634,0.05653943121433258,-0.09214431792497635,0.1551216095685959,0.2379094958305359],[0.03687307611107826,0.009700112044811249,-0.11818750947713852,0.06147775053977966,-0.008136298507452011,-0.11307837069034576,-0.05777150020003319,-0.1606748402118683,0.06372915208339691,0.07311329245567322,0.2510874569416046,0.08988822251558304,-0.15271584689617157,-0.11471755802631378,0.14351339638233185,0.02930120751261711],[-0.15843014419078827,-0.18816682696342468,-0.10758856683969498,-0.10504396259784698,-0.0497346930205822,0.04446299374103546,-0.04830916225910187,0.0144874332472682,-0.0450880192220211,0.11848877370357513,0.1305447369813919,0.10711207985877991,0.03359440714120865,0.14998073875904083,0.11800578981637955,0.25973275303840637],[-0.17557354271411896,0.08852818608283997,-0.059011053293943405,-0.019912144169211388,0.11544489115476608,-0.15294302999973297,-0.07223175466060638,-0.07593797147274017,0.04718990623950958,-0.0003903840552084148,0.15896418690681458,-0.04461337998509407,-0.02265152335166931,0.047475747764110565,0.01976967044174671,0.037762388586997986],[-0.098682701587677,-0.10785508900880814,0.038261983543634415,-0.17857623100280762,-0.024108750745654106,0.029642924666404724,-0.0833497866988182,-0.1927344799041748,-0.047898776829242706,-0.08977150171995163,0.15764875710010529,0.07725045830011368,-0.07032275944948196,0.17238305509090424,-0.07081275433301926,0.046770866960287094],[-0.04367094486951828,-0.02435140684247017,-0.0005203530890867114,0.052449725568294525,-0.005482879467308521,-0.019327638670802116,-0.0996701791882515,-0.04877311363816261,-0.16014418005943298,-0.011663859710097313,-0.051017191261053085,0.19113145768642426,0.09110107272863388,-0.10309714823961258,-0.09121442586183548,0.28796786069869995],[-0.06318733096122742,0.026486599817872047,-0.21775716543197632,-0.09165409952402115,-0.13094595074653625,-0.17012172937393188,-0.10679173469543457,0.05045361444354057,-0.18969376385211945,0.09203972667455673,0.2539460062980652,0.19979870319366455,0.20136629045009613,-0.10612406581640244,0.20841307938098907,0.19125604629516602],[0.05339923873543739,0.06193935498595238,-0.09972645342350006,0.06344956904649734,-0.0743732824921608,0.0304464902728796,0.00011906145664397627,-0.009997585788369179,0.009028373286128044,0.05848957970738411,0.18202924728393555,0.28150734305381775,-0.06877482682466507,0.044291261583566666,0.18516799807548523,-0.06733959913253784],[-0.014392239041626453,0.07984349131584167,-0.0327727384865284,-0.18265169858932495,-0.21992217004299164,-0.2395186424255371,-0.2087387889623642,-0.2763458788394928,-0.02212783321738243,-0.032633595168590546,0.04610326886177063,0.02715747058391571,0.19012309610843658,-0.12469398230314255,0.016338730230927467,0.23896123468875885]],[[-0.07102376222610474,-0.040409401059150696,0.11142241954803467,0.13330228626728058,-0.15813922882080078,0.22154772281646729,-0.12347891926765442,-0.19413542747497559],[-0.11436322331428528,-0.14364150166511536,0.16301174461841583,0.21155719459056854,0.14134833216667175,0.25891974568367004,0.22367504239082336,-0.1879940778017044],[-0.03440019488334656,0.1113118901848793,-0.019264834001660347,0.26016977429389954,0.3034471273422241,-0.08812569826841354,0.11491729319095612,-0.038715824484825134],[-0.20556232333183289,-0.07796230912208557,0.005304811522364616,0.3008832037448883,0.31462565064430237,0.03161622956395149,0.029159799218177795,-0.06287682056427002],[0.2227579653263092,0.04387185722589493,0.3058018982410431,0.013197186402976513,0.19379666447639465,0.19550299644470215,0.05827430263161659,0.00018911284860223532],[0.11087602376937866,-0.11713913083076477,0.02412966452538967,0.14213033020496368,0.07959204912185669,0.2674435079097748,0.06189151480793953,-0.028572211042046547],[-0.12261676788330078,0.20475360751152039,0.09686614573001862,0.30169928073883057,0.27076685428619385,0.10523375123739243,-0.14995169639587402,-0.13734912872314453],[-0.07247579097747803,0.004842082504183054,0.2887606620788574,0.08287527412176132,0.3135360777378082,0.08697183430194855,-0.13594932854175568,-0.30013614892959595],[-0.046846628189086914,0.12507395446300507,0.28670307993888855,0.22356773912906647,0.17214278876781464,-0.017061585560441017,0.16075652837753296,-0.0012082328321412206],[0.11828762292861938,0.08833327144384384,-0.023728368803858757,-0.008674945682287216,0.12074071168899536,0.2815748155117035,0.23321126401424408,0.13965117931365967],[-0.13967975974082947,-0.2310376763343811,-0.31638234853744507,0.2509855031967163,-0.01203199103474617,-0.281727135181427,-0.04282519221305847,0.268311470746994],[-0.18777674436569214,0.24815523624420166,0.12983830273151398,-0.09269783645868301,0.014929601922631264,0.09412369132041931,-0.15045508742332458,0.3451519012451172],[-0.10773810744285583,-0.23959645628929138,-0.010897625237703323,-0.16570746898651123,0.09611287713050842,0.019539402797818184,0.18410974740982056,0.23068426549434662],[-0.16053670644760132,-0.10350210964679718,-0.1195216253399849,0.09910515695810318,-0.2502841055393219,0.11831167340278625,0.2263525128364563,0.18168623745441437],[-0.24506768584251404,-0.12267899513244629,-0.1321844458580017,-0.29703980684280396,-0.06664082407951355,-0.18137356638908386,-0.2622491419315338,-0.007791631855070591],[-0.021096467971801758,-0.14048199355602264,-0.09537739306688309,-0.25821805000305176,-0.21384726464748383,-0.03330938518047333,0.11829648911952972,0.2968112528324127]],[[-0.18159087002277374],[-0.08469095826148987],[-0.14426852762699127],[-0.41430023312568665],[-0.30167466402053833],[-0.3572031259536743],[-0.2717922627925873],[0.2960704565048218]]],"max_display_units":200}
;
const __ACTIVATIONS__ = {"groups":{"default":{"0":[0.9145738482475281,0.9564381241798401,0.7694987654685974,0.6216904520988464,0.7457414269447327,0.5991314649581909],"1":[0.4057721495628357,0.41524285078048706,0.27211031317710876,0.36088231205940247,0.5012597441673279,0.4852868318557739,0.402646005153656,0.48399513959884644,0.5003721117973328,0.4544474184513092,0.4622715711593628,0.3725474178791046,0.5386690497398376,0.4399334490299225,0.4961130917072296,0.47772470116615295,0.38445502519607544,0.38106387853622437,0.39053982496261597,0.4340178966522217,0.428909569978714,0.4488683342933655,0.35846975445747375,0.40898141264915466,0.5004144906997681,0.4551582932472229,0.5330092310905457,0.39367812871932983,0.43991416692733765,0.3525368273258209,0.4247078597545624,0.36167508363723755],"2":[0.5060766339302063,0.5780834555625916,0.5157200694084167,0.3191113770008087,0.6802768111228943,1.0411036014556885,0.46088775992393494,0.18627704679965973,0.16834619641304016,0.6719770431518555,0.7632863521575928,1.0776292085647583,0.5143545269966125,1.2079899311065674,0.7188282608985901,0.7725912928581238],"3":[0.6564606428146362,0.9475913643836975,0.9827079176902771,0.0,0.002506367629393935,0.7383363246917725,0.9902607202529907,0.33119839429855347],"4":[1.3082009553909302]},"filter_a2275149":{"0":[1.0038150548934937,1.1520460844039917,0.7945517301559448,0.514597475528717,0.7698673605918884,0.7722406387329102],"1":[0.7212576866149902,0.6762853860855103,0.2717188000679016,0.4076375663280487,0.1698705554008484,0.1560511738061905,0.7725905776023865,0.8897751569747925,0.9795520901679993,0.2334216982126236,0.7202329635620117,0.4483163356781006,0.19239532947540283,0.1738799810409546,0.8243299126625061,0.20085181295871735,0.42619720101356506,0.18836760520935059,0.1955316811800003,0.3891701102256775,0.2210242748260498,0.2490781545639038,0.43128129839897156,0.2892805337905884,0.6968778371810913,0.36470434069633484,1.0359145402908325,0.49322760105133057,0.8242099285125732,0.40966904163360596,0.8861952424049377,0.6769832372665405],"2":[0.8997344970703125,0.2091713398694992,0.21996846795082092,0.09194383770227432,0.3084625005722046,1.6171278953552246,0.2068263441324234,0.3209117650985718,0.287082701921463,0.29730620980262756,0.3184019923210144,0.9546012878417969,0.1934356689453125,1.8125083446502686,1.3353712558746338,0.3344757556915283],"3":[0.216580331325531,0.323405921459198,1.806977391242981,0.0,0.0002887636364903301,0.26437580585479736,0.3373623788356781,0.12891742587089539],"4":[0.74302077293396]},"filter_04df8c7c":{"0":[0.8585761189460754,0.8336969614028931,0.7537774443626404,0.6888923645019531,0.7306022644042969,0.49050113558769226],"1":[0.20779788494110107,0.25143253803253174,0.2723560035228729,0.33154213428497314,0.7092142105102539,0.6918897032737732,0.17049755156040192,0.2293594926595688,0.1996757835149765,0.5931465029716492,0.30039510130882263,0.325001060962677,0.7559638023376465,0.6068882346153259,0.2901495695114136,0.6514689922332764,0.35826095938682556,0.501985490322113,0.5129120945930481,0.46216148138046265,0.55936199426651,0.5742412805557251,0.3127794563770294,0.4840964078903198,0.3771287500858307,0.5119200944900513,0.21742476522922516,0.33120936155319214,0.19875997304916382,0.3166850805282593,0.13511382043361664,0.16381163895130157],"2":[0.25904780626296997,0.8095846176147461,0.7013108730316162,0.46166443824768066,0.9135987162590027,0.6796345114707947,0.6203171610832214,0.10179063677787781,0.09383627772331238,0.9070920348167419,1.0424613952636719,1.1548316478729248,0.7157384157180786,0.828639030456543,0.33193376660346985,1.0475192070007324],"3":[0.9324957728385925,1.3392822742462158,0.46545958518981934,0.0,0.0038979649543762207,1.0357569456100464,1.3999699354171753,0.458134263753891],"4":[1.6628644466400146]},"filter_7971fcc9":{"0":[0.938549816608429,1.3425275087356567,0.7877659201622009,0.6485457420349121,0.9396024346351624,0.7199351191520691],"1":[0.628887951374054,0.870195746421814,0.400277704000473,0.32702624797821045,0.05990549549460411,0.013331333175301552,0.8349376916885376,0.8729246258735657,1.2823641300201416,0.06834376603364944,0.7730125784873962,0.6554542779922485,0.0,0.23301886022090912,1.153369665145874,0.04250796139240265,0.5052922964096069,0.40486717224121094,0.4128445088863373,0.41284066438674927,0.09318307042121887,0.1085924431681633,0.20600932836532593,0.14232566952705383,0.5365512371063232,0.6619418859481812,1.4907379150390625,0.6040258407592773,0.9378005862236023,0.6233423948287964,0.9924962520599365,0.7196329832077026],"2":[1.0677320957183838,0.11965372413396835,0.04088927432894707,0.06163382530212402,0.24534696340560913,1.8781241178512573,0.18555320799350739,0.2552986741065979,0.3692072033882141,0.30219149589538574,0.2143051028251648,0.8531737327575684,0.14143075048923492,2.252441883087158,1.4929612874984741,0.208327516913414],"3":[0.02921835519373417,0.20284108817577362,2.079559326171875,0.0,0.0,0.048379357904195786,0.2370499223470688,0.005754813551902771],"4":[0.5462350845336914]},"filter_8d0a61ee":{"0":[0.9014381170272827,0.7448707818984985,0.7594885230064392,0.6069726347923279,0.6395081281661987,0.5329317450523376],"1":[0.2835064232349396,0.16593174636363983,0.20187540352344513,0.37943512201309204,0.7431188821792603,0.7439152598381042,0.1657532900571823,0.2708650529384613,0.07184609770774841,0.6660298109054565,0.2919878661632538,0.21751677989959717,0.8338559865951538,0.553321123123169,0.1359410583972931,0.716220498085022,0.3182372450828552,0.3680199682712555,0.37831729650497437,0.4456234574317932,0.6128852367401123,0.6353371739387512,0.4420175850391388,0.5551069974899292,0.4806114435195923,0.34184229373931885,0.008180699311196804,0.2784097194671631,0.16707617044448853,0.20413723587989807,0.11356353759765625,0.1655164361000061],"2":[0.1982935667037964,0.8292997479438782,0.7759239077568054,0.46020743250846863,0.9186151027679443,0.5824218988418579,0.6117691397666931,0.14845366775989532,0.05827578529715538,0.8746172785758972,1.0641242265701294,1.200628399848938,0.7187142372131348,0.6356362700462341,0.2946091890335083,1.0818039178848267],"3":[1.0001850128173828,1.3557095527648926,0.38164055347442627,0.0,0.0038798395544290543,1.1164276599884033,1.403015375137329,0.5095392465591431],"4":[1.7257529497146606]},"filter_a133d921":{"0":[1.5605446100234985,1.004960060119629,0.9496946930885315,0.484409362077713,0.7065638303756714,1.1877790689468384],"1":[1.4700934886932373,0.9632275700569153,0.03643031418323517,0.7672267556190491,0.23944950103759766,0.18993322551250458,0.9575998783111572,1.2625030279159546,1.024655818939209,0.647524356842041,1.2836840152740479,0.3475334048271179,0.2565747797489166,0.03652258217334747,0.4348651170730591,0.3611726760864258,0.09211250394582748,0.011376344598829746,0.15546360611915588,0.24716317653656006,0.5453073382377625,0.2822036147117615,1.0144115686416626,0.41443783044815063,1.7195767164230347,0.0012366543523967266,0.7143415808677673,0.5800725221633911,1.1234934329986572,0.0516437366604805,0.972137451171875,1.0578324794769287],"2":[1.0250784158706665,0.22244033217430115,0.47687554359436035,0.11175063252449036,0.29337453842163086,2.0465099811553955,0.2621168792247772,0.7434957027435303,0.15865713357925415,0.2209625393152237,0.4845598638057709,1.3884775638580322,0.2014760673046112,1.987305998802185,1.528337836265564,0.5621297359466553],"3":[0.2660149335861206,0.37580597400665283,2.1219794750213623,0.0,0.0,0.4794398546218872,0.3909328877925873,0.23783063888549805],"4":[0.8301495313644409]},"filter_d0f799a5":{"0":[0.836913526058197,0.9215907454490662,0.7058403491973877,0.7328306436538696,0.776499330997467,0.4417892098426819],"1":[0.0,0.24645939469337463,0.3777589797973633,0.19527693092823029,0.6914000511169434,0.6619383692741394,0.15398842096328735,0.1512940675020218,0.27179691195487976,0.37553319334983826,0.17084801197052002,0.34244653582572937,0.719677746295929,0.7244629263877869,0.5061091184616089,0.5331367254257202,0.539124608039856,0.647404670715332,0.5685242414474487,0.6090482473373413,0.34284159541130066,0.5981181263923645,0.06859087944030762,0.38428932428359985,0.044736720621585846,0.7763481140136719,0.3988310694694519,0.2581155300140381,0.1417500227689743,0.49585482478141785,0.12676891684532166,0.06750895828008652],"2":[0.30293333530426025,0.8220438957214355,0.5783258676528931,0.46220070123672485,0.9673826098442078,0.635627806186676,0.5924360156059265,0.0016388994408771396,0.14849485456943512,0.9760364890098572,0.9951112866401672,0.9937571883201599,0.7088656425476074,0.9386772513389587,0.36947956681251526,0.9323152899742126],"3":[0.8772920966148376,1.310266375541687,0.4832890033721924,0.0,0.002956123324111104,0.9097124338150024,1.397975206375122,0.40399545431137085],"4":[1.6225444078445435]},"filter_c806b65c":{"0":[0.976799726486206,1.3425267934799194,0.7623660564422607,0.5258309245109558,0.8084332942962646,0.8308507800102234],"1":[0.8163908123970032,0.8798168897628784,0.2641877830028534,0.39445337653160095,0.019456475973129272,0.004824223928153515,0.9286618232727051,1.0040374994277954,1.383056879043579,0.05832229182124138,0.8323401212692261,0.6007014513015747,0.0,0.08021629601716995,1.0547610521316528,0.021213671192526817,0.499366819858551,0.18523606657981873,0.20618754625320435,0.2898349165916443,0.09050776064395905,0.11631938815116882,0.27024582028388977,0.1339241862297058,0.6621633768081665,0.4516431391239166,1.5190510749816895,0.5932472944259644,1.094555377960205,0.4566633999347687,1.1752228736877441,0.848055899143219],"2":[1.1182897090911865,0.05511373654007912,0.027434656396508217,0.017794130370020866,0.14134936034679413,1.9732462167739868,0.07958585768938065,0.3314175307750702,0.36568427085876465,0.1413099318742752,0.09211404621601105,0.877896785736084,0.04746338352560997,2.2582316398620605,1.6309947967529297,0.0900081917643547],"3":[0.008704542182385921,0.05791417136788368,2.2603611946105957,0.0,0.0,0.016448205336928368,0.07031234353780746,0.005569946952164173],"4":[0.5474063158035278]},"filter_9081ce7c":{"0":[0.8638224601745605,0.7448702454566956,0.7350894212722778,0.6343137621879578,0.6282477974891663,0.5061463117599487],"1":[0.22844409942626953,0.1482471227645874,0.18168652057647705,0.3661894202232361,0.8022516965866089,0.8060730695724487,0.10157090425491333,0.18285198509693146,0.06123539060354233,0.6797283887863159,0.24768242239952087,0.2398197501897812,0.8879316449165344,0.5954234004020691,0.08994141966104507,0.7470815777778625,0.32961854338645935,0.40865036845207214,0.4266069233417511,0.409003347158432,0.6393989324569702,0.6594091653823853,0.3636748790740967,0.5395400524139404,0.4123753309249878,0.38012829422950745,0.00936131365597248,0.2781714200973511,0.14846166968345642,0.17945338785648346,0.07719845324754715,0.1312706619501114],"2":[0.14326390624046326,0.8976157903671265,0.8098436594009399,0.5094830989837646,0.9780315160751343,0.5181816816329956,0.6430013179779053,0.11321638524532318,0.043996088206768036,0.9319011569023132,1.1256729364395142,1.2199058532714844,0.7688085436820984,0.5829951167106628,0.19856862723827362,1.1346017122268677],"3":[1.0798786878585815,1.46489417552948,0.27447766065597534,0.0,0.004578428342938423,1.1920878887176514,1.5192512273788452,0.5370128750801086],"4":[1.8583815097808838]}},"filter_index":{"filter_a2275149":{"column":"survived","op":"eq","value":"yes"},"filter_04df8c7c":{"column":"survived","op":"eq","value":"no"},"filter_7971fcc9":{"column":"sex","op":"eq","value":"female"},"filter_8d0a61ee":{"column":"sex","op":"eq","value":"male"},"filter_a133d921":{"column":"pclass","op":"eq","value":"1"},"filter_d0f799a5":{"column":"pclass","op":"eq","value":"3"},"filter_c806b65c":{"and":[{"column":"survived","op":"eq","value":"yes"},{"column":"sex","op":"eq","value":"female"}]},"filter_9081ce7c":{"and":[{"column":"survived","op":"eq","value":"no"},{"column":"sex","op":"eq","value":"male"}]}}}
;
/* NeuronLens – main.js
 * Pure vanilla JS, no external dependencies required.
 * Data is inlined as __NETWORK__ and __ACTIVATIONS__ by the Python renderer.
 */

"use strict";

// ── Constants ────────────────────────────────────────────────────────────────

const MAX_EDGE_ALPHA = 0.55;
const DIM_ALPHA      = 0.2;   // softened dim for non-hovered neurons

// Gamma correction: maps normalised activation v∈[0,1] → display value ∈[0,1].
// Convex function that amplifies differences near the maximum so bright neurons
// stand out clearly while dim neurons remain visible.
// Formula: ((v+1)² − 1) / 3  (maps 0→0, 0.5→0.417, 1→1)
function applyGamma(v) {
  const u = v < 0 ? 0 : v > 1 ? 1 : v;
  return ((u + 1) * (u + 1) - 1) / 3;
}

const COLOR_A   = { r: 88,  g: 166, b: 255 };  // #58a6ff  (blue)
const COLOR_B   = { r: 255, g: 100, b: 100 };  // #ff6464  (red)
const COLOR_SIG = { r: 255, g: 200, b: 80  };  // warm amber (hover signal)

const FADE_IN_MS  = 100;   // ms to blend into hover state
const FADE_OUT_MS = 300;   // ms to blend back to normal

// ── State ─────────────────────────────────────────────────────────────────────

let network     = null;
let activations = null;
let canvasEl, ctx;
let mode         = "single";   // "single" | "compare"
let filterGroupA = "default";
let filterGroupB = "default";
let layout       = null;

// Hover animation state — replaces the old hoveredNeuron boolean
const hoverState = {
  neuron:    null,   // { layerIdx, neuronIdx } — persists during fade-out
  alpha:     0,      // current blend [0 = normal, 1 = full hover]
  target:    0,      // animation target (0 or 1)
  animFrom:  0,      // alpha when current animation started
  animStart: null,   // DOMHighResTimeStamp when animation started
  rafId:     null,   // requestAnimationFrame handle
};

// ── Boot ─────────────────────────────────────────────────────────────────────

window.addEventListener("DOMContentLoaded", () => {
  canvasEl    = document.getElementById("main-canvas");
  ctx         = canvasEl.getContext("2d");
  network     = __NETWORK__;
  activations = __ACTIVATIONS__;

  buildUI();
  buildLayout();
  render();

  canvasEl.addEventListener("mousemove",  onMouseMove);
  canvasEl.addEventListener("mouseleave", onMouseLeave);
  window.addEventListener("resize", () => { buildLayout(); render(); });
});

// ── UI ────────────────────────────────────────────────────────────────────────

function buildUI() {
  const groups      = Object.keys(activations.groups);
  const filterIndex = activations.filter_index || {};

  function specToLabel(spec) {
    if (spec.and) return spec.and.map(specToLabel).join(" & ");
    const opMap = { eq:"=", ne:"≠", lt:"<", le:"≤", gt:">", ge:"≥", in:"∈", not_in:"∉" };
    return `${spec.column} ${opMap[spec.op] || spec.op} ${JSON.stringify(spec.value)}`;
  }
  function groupLabel(key) {
    if (key === "default") return "All data";
    const spec = filterIndex[key];
    return spec ? specToLabel(spec) : key;
  }
  function populateSelect(id, onChange) {
    const sel = document.getElementById(id);
    groups.forEach(g => {
      const opt = document.createElement("option");
      opt.value = g; opt.textContent = groupLabel(g);
      sel.appendChild(opt);
    });
    sel.addEventListener("change", () => { onChange(sel.value); render(); });
    return sel;
  }

  populateSelect("filter-a", v => { filterGroupA = v; });
  const selB = populateSelect("filter-b", v => { filterGroupB = v; });
  selB.value   = groups[Math.min(1, groups.length - 1)];
  filterGroupB = selB.value;

  document.getElementById("btn-single").addEventListener("click", () => {
    mode = "single";
    document.getElementById("btn-single").classList.add("active");
    document.getElementById("btn-compare").classList.remove("active");
    document.getElementById("compare-row").style.display = "none";
    render();
  });
  document.getElementById("btn-compare").addEventListener("click", () => {
    mode = "compare";
    document.getElementById("btn-compare").classList.add("active");
    document.getElementById("btn-single").classList.remove("active");
    document.getElementById("compare-row").style.display = "flex";
    render();
  });
}

// ── Layout ────────────────────────────────────────────────────────────────────

function buildLayout() {
  if (!network) return;
  const layers = network.layers;
  const n      = layers.length;

  const container = canvasEl.parentElement;
  const availW    = Math.max(container.clientWidth,  400);
  const availH    = Math.max(container.clientHeight, 300);

  // For neuron sizing: only count linear (non-spatial) layers so that large
  // conv grids don't shrink the neuron radius for all linear layers.
  const maxLinearUnits = Math.max(...layers.map((l, li) => isCNNLayer(li) ? 0 : l.n_display_units), 1);

  // ── Label area ──────────────────────────────────────────────────────────
  const labelFontSize = Math.max(Math.min(Math.round(availH * 0.018), 15), 10);
  const labelAreaH    = Math.ceil(labelFontSize * 2.8);  // room for 2 text lines

  // ── Block vertical padding ───────────────────────────────────────────────
  const blockPadV = Math.max(Math.round(availH * 0.03), 4);

  // ── Neuron sizing: fill 88 % of canvas height, sized by linear layers ────
  const neuronSpaceH = availH * 0.88 - labelAreaH - 2 * blockPadV;
  const unitH        = neuronSpaceH / maxLinearUnits;
  const neuronR      = Math.max(Math.floor(unitH * 0.42), 1);
  const cellSize     = neuronR * 2;   // square side for conv cells
  const neuronGap    = Math.max(unitH - cellSize, 1);
  const step         = cellSize + neuronGap;

  // ── Per-layer column height (including gaps between cells) ───────────────
  function colHeight(layer, li) {
    if (isCNNLayer(li)) return layer.spatial_h * cellSize + (layer.spatial_h - 1) * neuronGap;
    return layer.n_display_units * step - neuronGap;
  }

  // ── Total content height for the tallest column ──────────────────────────
  const maxNeuronColH = Math.max(...layers.map((l, li) => colHeight(l, li)), 1);
  const totalContentH = labelAreaH + blockPadV + maxNeuronColH + blockPadV;

  // ── Vertical centering: shift so content sits in the middle ──────────────
  const topOffset  = Math.max((availH - totalContentH) / 2, 4);

  // ── Derived y coordinates (stored in layout for draw functions) ──────────
  const labelY1    = topOffset + labelFontSize * 1.0;
  const labelY2    = topOffset + labelFontSize * 2.2;
  const blockTopY  = topOffset + labelAreaH;
  const blockBotY  = blockTopY + blockPadV + maxNeuronColH + blockPadV;
  const neuronTopY = blockTopY + blockPadV;

  // ── Horizontal layout: spread layers evenly ──────────────────────────────
  const PAD_SIDE     = Math.round(availW * 0.03);
  const innerW       = availW - PAD_SIDE * 2 - cellSize;
  const layerSpacing = n > 1 ? innerW / (n - 1) : 0;

  // ── Per-layer positions ──────────────────────────────────────────────────
  const layoutLayers = layers.map((layer, li) => {
    const cx     = PAD_SIDE + cellSize / 2 + li * layerSpacing;
    const ch     = colHeight(layer, li);
    const startY = neuronTopY + (maxNeuronColH - ch) / 2;
    const neurons = [];

    if (isCNNLayer(li)) {
      // 2-D grid: neuron k = h*sW + w positioned at its cell centre
      const sH = layer.spatial_h, sW = layer.spatial_w;
      for (let h = 0; h < sH; h++) {
        for (let w = 0; w < sW; w++) {
          neurons.push({
            x: cx + (w - sW / 2 + 0.5) * step,
            y: startY + h * step + cellSize / 2,
          });
        }
      }
    } else {
      const nu = layer.n_display_units;
      for (let k = 0; k < nu; k++)
        neurons.push({ x: cx, y: startY + k * step + cellSize / 2 });
    }

    // Full grid width for conv; single cell diameter for linear
    const heatmapW = isCNNLayer(li) ? layer.spatial_w * step - neuronGap : cellSize;
    return { cx, neurons, heatmapW };
  });

  const maxEdgeWidth = Math.max(neuronR * 0.35, 2);
  const blockPadH    = Math.max(neuronR * 0.7,  4);
  const canvasW      = availW;
  const canvasH      = availH;

  // Scale by devicePixelRatio so text/lines are sharp on retina displays
  const dpr = window.devicePixelRatio || 1;
  canvasEl.width        = Math.round(canvasW * dpr);
  canvasEl.height       = Math.round(canvasH * dpr);
  canvasEl.style.width  = canvasW + "px";
  canvasEl.style.height = canvasH + "px";

  layout = {
    layers: layoutLayers,
    canvasW, canvasH, dpr,
    neuronR, neuronGap, cellSize, step, maxEdgeWidth, labelFontSize,
    labelY1, labelY2,
    blockTopY, blockBotY, blockPadH,
  };

  const sb = document.getElementById("status-bar");
  if (sb) sb.textContent = layers.map(l =>
    `${l.name}: ${l.n_neurons}${l.aggregated ? ` (${l.n_display_units} buckets)` : ""}`
  ).join("  ·  ");
}

// ── Activation helpers ────────────────────────────────────────────────────────

function getActivations(groupKey, layerIdx) {
  const grp = activations.groups[groupKey];
  return grp ? (grp[String(layerIdx)] || null) : null;
}

// Returns activations in DISPLAY ORDER (display unit k → its activation).
// raw[] is stored in original-neuron order; perm[display_pos] = original_idx.
// For CNN layers raw[c] is a spatial array; this function returns the channel MEAN
// (a scalar) so the rest of the signal-propagation logic stays unchanged.
function getDisplayActivations(groupKey, layerIdx) {
  const raw   = getActivations(groupKey, layerIdx);
  if (!raw) return null;
  const layer = network.layers[layerIdx];
  const perm  = layer.perm;
  // CNN spatial data: each entry is a flat H×W array rather than a scalar
  const isSpatial = Array.isArray(raw[0]);

  function unitMean(rawVal) {
    if (!isSpatial) return rawVal || 0;
    if (!Array.isArray(rawVal) || rawVal.length === 0) return 0;
    let s = 0;
    for (let i = 0; i < rawVal.length; i++) s += rawVal[i];
    return s / rawVal.length;
  }

  if (!layer.aggregated) {
    return perm.map(origIdx => unitMean(raw[origIdx]));
  }

  // Aggregated: average over bucket of original neurons / channels
  const bs      = layer.bucket_size;
  const nu      = layer.n_display_units;
  const display = new Array(nu).fill(0);
  for (let k = 0; k < nu; k++) {
    let sum = 0, cnt = 0;
    for (let b = 0; b < bs; b++) {
      const pos = k * bs + b;
      if (pos >= perm.length) break;
      sum += unitMean(raw[perm[pos]]);
      cnt++;
    }
    display[k] = cnt > 0 ? sum / cnt : 0;
  }
  return display;
}

// Returns the spatial (H×W) activation array for a CNN channel in display order.
// Returns null for non-CNN layers or if spatial data is unavailable.
function getDisplaySpatialData(groupKey, layerIdx) {
  const raw = getActivations(groupKey, layerIdx);
  if (!raw || !Array.isArray(raw[0])) return null;
  const layer = network.layers[layerIdx];
  return layer.perm.map(origIdx => raw[origIdx] || null);
}

function normalizeArray(arr) {
  if (!arr || arr.length === 0) return arr;
  const mx = Math.max(...arr, 1e-9);
  return arr.map(v => v / mx);
}

// ── Edge weight lookup ────────────────────────────────────────────────────────

// edges[l][display_i][display_j] = weight from display unit i (layer l)
//                                  to display unit j (layer l+1)
// For aggregated layers, average over the bucket of underlying neurons.
function getBucketWeight(fromLayerIdx, i_disp, j_disp) {
  const edges   = network.edges[fromLayerIdx];
  if (!edges) return 0;
  const fromLayer = network.layers[fromLayerIdx];
  const toLayer   = network.layers[fromLayerIdx + 1];
  const bs_in     = fromLayer.bucket_size;
  const bs_out    = toLayer.bucket_size;

  let sum = 0, cnt = 0;
  for (let bi = 0; bi < bs_in; bi++) {
    const ri = i_disp * bs_in + bi;
    if (ri >= edges.length) break;
    for (let bj = 0; bj < bs_out; bj++) {
      const rj = j_disp * bs_out + bj;
      if (rj >= toLayer.n_neurons) break;
      if (!edges[ri] || rj >= edges[ri].length) continue;
      sum += Math.abs(edges[ri][rj]);
      cnt++;
    }
  }
  return cnt > 0 ? sum / cnt : 0;
}

// ── Hover signal propagation ──────────────────────────────────────────────────

function computeHoverSignal(layerIdx, neuronIdx) {
  const n      = network.layers.length;
  const signal = new Array(n).fill(null);

  // Seed with the hovered neuron's actual activation
  const rawActs = getDisplayActivations(filterGroupA, layerIdx) || [];
  const seedVal = rawActs[neuronIdx] || 0;
  const seedLayer = new Array(network.layers[layerIdx].n_display_units).fill(0);
  seedLayer[neuronIdx] = seedVal;
  signal[layerIdx]     = seedLayer;

  // Forward pass
  for (let l = layerIdx; l < n - 1; l++) {
    const n_out = network.layers[l + 1].n_display_units;
    const n_in  = network.layers[l].n_display_units;
    const next  = new Array(n_out).fill(0);
    for (let i = 0; i < n_in; i++) {
      const src = signal[l][i];
      if (!src || src < 1e-15) continue;
      for (let j = 0; j < n_out; j++)
        next[j] += getBucketWeight(l, i, j) * src;
    }
    signal[l + 1] = next;
  }
  return signal;
}

// ── Colour helpers ────────────────────────────────────────────────────────────

function neuronColor(normA, normB) {
  if (mode === "compare" && normB !== null) {
    const total = normA + normB;
    if (total < 1e-9) return { r: 30, g: 35, b: 45, a: 0.5 };
    const tB = normB / total, tA = 1 - tB;
    const brightness = applyGamma(Math.min(total / 2, 1));
    return {
      r: Math.round(COLOR_A.r * tA + COLOR_B.r * tB),
      g: Math.round(COLOR_A.g * tA + COLOR_B.g * tB),
      b: Math.round(COLOR_A.b * tA + COLOR_B.b * tB),
      a: 0.2 + brightness * 0.8,
    };
  }
  const v = applyGamma(normA || 0);
  return {
    r: Math.round(30 + v * (COLOR_A.r - 30)),
    g: Math.round(35 + v * (COLOR_A.g - 35)),
    b: Math.round(45 + v * (COLOR_A.b - 45)),
    a: 0.3 + v * 0.7,
  };
}

function signalColor(normSig) {
  const v = applyGamma(normSig || 0);
  return {
    r: Math.round(30 + v * (COLOR_SIG.r - 30)),
    g: Math.round(35 + v * (COLOR_SIG.g - 35)),
    b: Math.round(45 + v * (COLOR_SIG.b - 45)),
    a: 0.25 + v * 0.75,
  };
}

// Linear interpolation between two colour objects
function lerpColor(a, b, t) {
  if (t <= 0) return a;
  if (t >= 1) return b;
  return {
    r: Math.round(a.r + (b.r - a.r) * t),
    g: Math.round(a.g + (b.g - a.g) * t),
    b: Math.round(a.b + (b.b - a.b) * t),
    a: a.a + (b.a - a.a) * t,
  };
}

// ── CNN helpers ───────────────────────────────────────────────────────────────

// True for conv blocks and the input layer when it carries image/spatial data.
// Returns false for tabular input layers (no spatial_h).
function isCNNLayer(layerIdx) {
  const layer = network.layers[layerIdx];
  return (layer.type === "conv" || layer.type === "input") && !!layer.spatial_h;
}

// Persistent buffer canvas for heatmap rendering (avoids GC churn).
let _heatmapBuffer     = null;
let _heatmapBufferW    = 0;
let _heatmapBufferH    = 0;

function _getHeatmapBuffer(sW, sH) {
  if (!_heatmapBuffer || _heatmapBufferW < sW || _heatmapBufferH < sH) {
    _heatmapBuffer  = document.createElement("canvas");
    _heatmapBufferW = Math.max(sW, _heatmapBufferW);
    _heatmapBufferH = Math.max(sH, _heatmapBufferH);
    _heatmapBuffer.width  = _heatmapBufferW;
    _heatmapBuffer.height = _heatmapBufferH;
  }
  return _heatmapBuffer;
}

// Draw a 2-D spatial heatmap at (x,y) sized (dispW × dispH).
// spatialFlat: flat Float array of length sH*sW (row-major).
// col: colour object {r,g,b,a} used as the peak colour.
function drawSpatialHeatmap(x, y, dispW, dispH, spatialFlat, sH, sW, col) {
  const buf = _getHeatmapBuffer(sW, sH);
  const bc  = buf.getContext("2d");
  const img = bc.createImageData(sW, sH);
  let maxV  = 1e-9;
  for (let i = 0; i < sH * sW; i++) if (spatialFlat[i] > maxV) maxV = spatialFlat[i];

  for (let i = 0; i < sH * sW; i++) {
    const v = applyGamma((spatialFlat[i] || 0) / maxV);
    img.data[i * 4]     = Math.round(30 + v * (col.r - 30));
    img.data[i * 4 + 1] = Math.round(35 + v * (col.g - 35));
    img.data[i * 4 + 2] = Math.round(45 + v * (col.b - 45));
    img.data[i * 4 + 3] = 255;  // alpha baked in; use globalAlpha below
  }
  bc.putImageData(img, 0, 0);

  ctx.globalAlpha          = col.a;
  ctx.imageSmoothingEnabled = false;  // keep crisp pixels at small sizes
  ctx.drawImage(buf, 0, 0, sW, sH, x, y, dispW, dispH);
  ctx.globalAlpha          = 1;
  ctx.imageSmoothingEnabled = true;
}

// ── Block backgrounds ─────────────────────────────────────────────────────────

function roundedRect(x, y, w, h, r) {
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

function drawBlockBackgrounds() {
  const n      = network.layers.length;
  const r      = layout.neuronR;
  const padH   = layout.blockPadH;
  const corner = Math.max(r * 0.5, 6);

  for (let l = 0; l < n; l++) {
    if (layout.layers[l].neurons.length === 0) continue;
    const cx = layout.layers[l].cx;
    const hw = layout.layers[l].heatmapW / 2;
    const x  = cx - hw - padH;
    const w  = hw * 2 + 2 * padH;

    ctx.beginPath();
    roundedRect(x, layout.blockTopY, w, layout.blockBotY - layout.blockTopY, corner);
    ctx.fillStyle   = "rgba(255,255,255,0.025)";
    ctx.fill();
    ctx.strokeStyle = "rgba(255,255,255,0.07)";
    ctx.lineWidth   = 1;
    ctx.stroke();
  }
}

// ── Hover animation ───────────────────────────────────────────────────────────

function startHoverAnim(target) {
  if (hoverState.rafId) cancelAnimationFrame(hoverState.rafId);
  hoverState.target    = target;
  hoverState.animFrom  = hoverState.alpha;
  hoverState.animStart = null;
  hoverState.rafId     = requestAnimationFrame(animStep);
}

function animStep(ts) {
  if (hoverState.animStart === null) hoverState.animStart = ts;
  const elapsed = ts - hoverState.animStart;
  const dur     = hoverState.target === 1 ? FADE_IN_MS : FADE_OUT_MS;
  const t       = Math.min(elapsed / dur, 1);
  hoverState.alpha = hoverState.animFrom + (hoverState.target - hoverState.animFrom) * t;
  render();
  if (t < 1) {
    hoverState.rafId = requestAnimationFrame(animStep);
  } else {
    hoverState.rafId = null;
    if (hoverState.target === 0) hoverState.neuron = null;  // fully faded out
  }
}

// ── Rendering ─────────────────────────────────────────────────────────────────

function render() {
  if (!network || !layout) return;
  const { canvasW, canvasH, dpr } = layout;
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.clearRect(0, 0, canvasW, canvasH);

  const n     = network.layers.length;
  const ha    = hoverState.alpha;   // 0 = normal, 1 = full hover
  const hovL  = hoverState.neuron ? hoverState.neuron.layerIdx  : -1;
  const hovK  = hoverState.neuron ? hoverState.neuron.neuronIdx : -1;

  const actsA = network.layers.map((_, i) =>
    normalizeArray(getDisplayActivations(filterGroupA, i))
  );
  const actsB = mode === "compare"
    ? network.layers.map((_, i) => normalizeArray(getDisplayActivations(filterGroupB, i)))
    : null;

  // Precompute hover signal when any hover effect is visible
  let hoverSigNorm = null;
  if (hoverState.neuron && ha > 0) {
    const raw = computeHoverSignal(hovL, hovK);
    hoverSigNorm = raw.map(s => s ? normalizeArray(s) : null);
  }

  // Draw order: backgrounds → edges → neurons → labels
  drawBlockBackgrounds();
  for (let l = 0; l < n - 1; l++) drawEdges(l, actsA, actsB, hoverSigNorm, hovL, hovK, ha);
  for (let l = 0; l < n;     l++) drawLayer(l, actsA[l], actsB ? actsB[l] : null, hoverSigNorm, hovL, hovK, ha);

  ctx.font      = `${layout.labelFontSize}px -apple-system, monospace`;
  ctx.textAlign = "center";
  ctx.fillStyle = "#8b949e";
  for (let l = 0; l < n; l++) {
    const lx    = layout.layers[l].cx;
    const layer = network.layers[l];
    const label = layer.block_label || layer.name;
    const sublabel = layer.spatial_h
      ? `(${layer.channels || layer.n_neurons} ch, ${layer.spatial_h}×${layer.spatial_w})`
      : `(${layer.n_neurons})`;
    ctx.fillText(label,    lx, layout.labelY1);
    ctx.fillText(sublabel, lx, layout.labelY2);
  }
}

function drawLayer(layerIdx, normsA, normsB, hoverSigNorm, hovL, hovK, ha) {
  // CNN layers (conv blocks or spatial image input) render as a 2-D cell grid
  if (isCNNLayer(layerIdx)) {
    drawCNNLayer(layerIdx, normsA, normsB, hoverSigNorm, hovL, hovK, ha);
    return;
  }

  const layerLayout = layout.layers[layerIdx];
  const nu          = layerLayout.neurons.length;
  const r           = layout.neuronR;

  for (let k = 0; k < nu; k++) {
    const { x, y } = layerLayout.neurons[k];

    // ── Compute base (normal) colour ────────────────────────────────────────
    const normCol = neuronColor(normsA ? normsA[k] : 0, normsB ? normsB[k] : null);

    // ── Compute hover colour for this neuron ────────────────────────────────
    let hoverCol  = normCol;
    let isHovered = false;

    if (hoverSigNorm && ha > 0) {
      if (layerIdx < hovL) {
        hoverCol = { ...normCol, a: DIM_ALPHA };
      } else if (layerIdx === hovL) {
        if (k === hovK) {
          hoverCol  = normCol;   // hovered neuron stays at normal colour
          isHovered = true;
        } else {
          hoverCol = { ...normCol, a: DIM_ALPHA };
        }
      } else {
        // Downstream: colour by propagated signal
        const sig = hoverSigNorm[layerIdx] ? (hoverSigNorm[layerIdx][k] || 0) : 0;
        hoverCol  = signalColor(sig);
      }
    }

    // ── Blend normal → hover by ha ──────────────────────────────────────────
    const col   = lerpColor(normCol, hoverCol, ha);
    const alpha = col.a;

    ctx.beginPath();
    ctx.arc(x, y, r, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(${col.r},${col.g},${col.b},${alpha})`;
    ctx.fill();

    // Glow
    if (alpha > 0.4) {
      const glowVal = (hoverSigNorm && layerIdx > hovL)
        ? (hoverSigNorm[layerIdx] ? (hoverSigNorm[layerIdx][k] || 0) : 0)
        : (normsA ? normsA[k] : 0);
      if (glowVal > 0.3) {
        ctx.shadowColor = `rgb(${col.r},${col.g},${col.b})`;
        ctx.shadowBlur  = r * 0.4 + r * 0.4 * glowVal;
        ctx.fill();
        ctx.shadowBlur  = 0;
      }
    }

    // Border
    ctx.strokeStyle = (isHovered && ha > 0.5)
      ? `rgba(255,255,255,${0.6 + ha * 0.35})`
      : `rgba(${col.r},${col.g},${col.b},${Math.min(alpha + 0.2, 1)})`;
    ctx.lineWidth   = (isHovered && ha > 0.5) ? 2 : 1;
    ctx.stroke();
  }
}

// Renders a conv/input layer as a 2-D grid of spatial cells.
// neuron k = row h, column w  where  k = h * spatial_w + w.
// Each cell is a cellSize × cellSize square with full per-cell hover behaviour
// identical to linear neurons: dimming, signal propagation, glow.
function drawCNNLayer(layerIdx, normsA, normsB, hoverSigNorm, hovL, hovK, ha) {
  const layerLayout = layout.layers[layerIdx];
  const layer       = network.layers[layerIdx];
  const nu          = layer.n_display_units;  // = spatial_h * spatial_w
  const cs          = layout.cellSize;
  const r           = layout.neuronR;

  for (let k = 0; k < nu; k++) {
    const { x, y } = layerLayout.neurons[k];
    const cellX = x - cs / 2;
    const cellY = y - cs / 2;

    // ── Base colour ──────────────────────────────────────────────────────
    const normCol = neuronColor(normsA ? normsA[k] : 0, normsB ? normsB[k] : null);

    // ── Hover colour for this cell ───────────────────────────────────────
    let hoverCol  = normCol;
    let isHovered = false;

    if (hoverSigNorm && ha > 0) {
      if (layerIdx < hovL) {
        hoverCol = { ...normCol, a: DIM_ALPHA };
      } else if (layerIdx === hovL) {
        if (k === hovK) {
          hoverCol  = normCol;
          isHovered = true;
        } else {
          hoverCol = { ...normCol, a: DIM_ALPHA };
        }
      } else {
        // Downstream: colour by propagated signal
        const sig = hoverSigNorm[layerIdx] ? (hoverSigNorm[layerIdx][k] || 0) : 0;
        hoverCol  = signalColor(sig);
      }
    }

    // ── Blend normal → hover by ha ───────────────────────────────────────
    const col = lerpColor(normCol, hoverCol, ha);

    ctx.fillStyle = `rgba(${col.r},${col.g},${col.b},${col.a})`;
    ctx.fillRect(cellX, cellY, cs, cs);

    // Glow for active cells
    if (col.a > 0.4) {
      const glowVal = (hoverSigNorm && layerIdx > hovL)
        ? (hoverSigNorm[layerIdx] ? (hoverSigNorm[layerIdx][k] || 0) : 0)
        : (normsA ? normsA[k] : 0);
      if (glowVal > 0.3) {
        ctx.shadowColor = `rgb(${col.r},${col.g},${col.b})`;
        ctx.shadowBlur  = r * 0.4 + r * 0.4 * glowVal;
        ctx.fillRect(cellX, cellY, cs, cs);
        ctx.shadowBlur  = 0;
      }
    }

    // Highlight border on hovered cell
    if (isHovered && ha > 0.5) {
      ctx.strokeStyle = `rgba(255,255,255,${0.6 + ha * 0.35})`;
      ctx.lineWidth   = 2;
      ctx.strokeRect(cellX, cellY, cs, cs);
    }
  }

  // Outer border around the whole grid
  if (nu > 0) {
    const first  = layerLayout.neurons[0];
    const last   = layerLayout.neurons[nu - 1];
    const gridX  = first.x - cs / 2;
    const gridY  = first.y - cs / 2;
    const gridW  = last.x  + cs / 2 - gridX;
    const gridH  = last.y  + cs / 2 - gridY;
    const dimAmt = (hoverSigNorm && ha > 0 && layerIdx < hovL)
      ? 1.0 - (1.0 - DIM_ALPHA) * ha : 1.0;
    ctx.strokeStyle = `rgba(255,255,255,${0.25 * dimAmt})`;
    ctx.lineWidth   = 1;
    ctx.strokeRect(gridX, gridY, gridW, gridH);
  }
}

function drawEdges(fromLayerIdx, actsA, actsB, hoverSigNorm, hovL, hovK, ha) {
  // No edges drawn to or from spatial-matrix layers (conv/input with spatial dims)
  if (isCNNLayer(fromLayerIdx) || isCNNLayer(fromLayerIdx + 1)) return;

  const toLayerIdx = fromLayerIdx + 1;
  const edges      = network.edges[fromLayerIdx];
  if (!edges) return;

  const fromLayer = network.layers[fromLayerIdx];
  const toLayer   = network.layers[toLayerIdx];
  const n_in      = fromLayer.n_display_units;
  const n_out     = toLayer.n_display_units;

  // Pre-compute max weight for normalisation
  let maxW = 0;
  for (let i = 0; i < n_in; i++)
    for (let j = 0; j < n_out; j++)
      maxW = Math.max(maxW, getBucketWeight(fromLayerIdx, i, j));
  if (maxW < 1e-12) return;

  for (let i = 0; i < n_in; i++) {
    const { x: x1, y: y1 } = layout.layers[fromLayerIdx].neurons[i];

    for (let j = 0; j < n_out; j++) {
      const { x: x2, y: y2 } = layout.layers[toLayerIdx].neurons[j];
      const w     = getBucketWeight(fromLayerIdx, i, j);
      const normW = w / maxW;
      if (normW < 0.01) continue;

      // ── Normal state ──────────────────────────────────────────────────────
      const srcA      = actsA[fromLayerIdx] ? actsA[fromLayerIdx][i] : 0;
      const srcB      = actsB && actsB[fromLayerIdx] ? actsB[fromLayerIdx][i] : null;
      const normAlpha = normW * MAX_EDGE_ALPHA;
      const normCol   = neuronColor(srcA, srcB);

      // ── Hover state ───────────────────────────────────────────────────────
      let hoverAlpha = normAlpha;
      let hoverCol   = normCol;

      if (hoverSigNorm && ha > 0) {
        if (fromLayerIdx < hovL) {
          // Before hovered layer: dim
          hoverAlpha = normW * MAX_EDGE_ALPHA * DIM_ALPHA;
          hoverCol   = neuronColor(0, null);

        } else if (fromLayerIdx === hovL) {
          // From hovered layer: only the hovered neuron's edges remain
          hoverAlpha = (i === hovK) ? normAlpha : 0;
          if (i === hovK) {
            hoverCol = neuronColor(actsA[fromLayerIdx] ? actsA[fromLayerIdx][hovK] : 0, null);
          }

        } else {
          // Downstream: scale by propagated signal
          const sigNorm = hoverSigNorm[fromLayerIdx];
          const sigVal  = sigNorm ? (sigNorm[i] || 0) : 0;
          hoverAlpha    = normW * sigVal * MAX_EDGE_ALPHA;
          hoverCol      = signalColor(sigVal);
        }
      }

      // ── Blend normal → hover ──────────────────────────────────────────────
      const alpha = normAlpha + (hoverAlpha - normAlpha) * ha;
      const col   = lerpColor(normCol, hoverCol, ha);

      if (alpha < 0.005) continue;

      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      ctx.strokeStyle = `rgba(${col.r},${col.g},${col.b},${alpha})`;
      ctx.lineWidth   = normW * layout.maxEdgeWidth;
      ctx.stroke();
    }
  }
}

// ── Hover interaction ─────────────────────────────────────────────────────────

function onMouseMove(e) {
  const rect = canvasEl.getBoundingClientRect();
  const mx   = e.clientX - rect.left;
  const my   = e.clientY - rect.top;

  let found = null;
  const cs = layout.cellSize;
  const r  = layout.neuronR;
  outer: for (let l = 0; l < layout.layers.length; l++) {
    const cnn = isCNNLayer(l);
    for (let k = 0; k < layout.layers[l].neurons.length; k++) {
      const { x, y } = layout.layers[l].neurons[k];
      if (cnn) {
        // Rectangular hit test for conv cells
        if (mx >= x - cs / 2 && mx <= x + cs / 2 &&
            my >= y - cs / 2 && my <= y + cs / 2) {
          found = { layerIdx: l, neuronIdx: k };
          break outer;
        }
      } else {
        // Circular hit test for linear neurons
        const dx = mx - x, dy = my - y;
        if (dx * dx + dy * dy <= (r + 3) ** 2) {
          found = { layerIdx: l, neuronIdx: k };
          break outer;
        }
      }
    }
  }

  // Same neuron as already shown — just nudge the tooltip
  if (found && hoverState.neuron &&
      found.layerIdx  === hoverState.neuron.layerIdx &&
      found.neuronIdx === hoverState.neuron.neuronIdx) {
    updateTooltip(e.clientX, e.clientY, found);
    return;
  }

  if (found) {
    hoverState.neuron = found;
    startHoverAnim(1);
    updateTooltip(e.clientX, e.clientY, found);
  } else {
    startHoverAnim(0);
    hideTooltip();
  }
}

function onMouseLeave() {
  hideTooltip();
  startHoverAnim(0);
}

function updateTooltip(cx, cy, { layerIdx, neuronIdx }) {
  const tt    = document.getElementById("tooltip");
  const layer = network.layers[layerIdx];
  const dispA = getDisplayActivations(filterGroupA, layerIdx) || [];
  const nA    = dispA[neuronIdx] || 0;
  const nB    = mode === "compare"
    ? ((getDisplayActivations(filterGroupB, layerIdx) || [])[neuronIdx] || 0)
    : null;

  const cnn = isCNNLayer(layerIdx);
  let html  = `<div class="tt-title">${layer.block_label || layer.name} — ${cnn ? "cell" : "unit"} ${neuronIdx}</div>`;

  if (cnn) {
    // Show the (row, col) position within the spatial grid
    const h = Math.floor(neuronIdx / layer.spatial_w);
    const w = neuronIdx % layer.spatial_w;
    html += `<div class="tt-row"><span class="tt-label">Position</span>
      <span class="tt-val">(${h}, ${w})</span></div>`;
  } else if (layer.aggregated) {
    const s = neuronIdx * layer.bucket_size;
    const e = Math.min(s + layer.bucket_size - 1, layer.n_neurons - 1);
    html += `<div class="tt-row"><span class="tt-label">Neurons</span>
      <span class="tt-val">${s}–${e}</span></div>`;
  }

  const actLabel = cnn ? "Mean |act|" : "Activation";
  html += `<div class="tt-row"><span class="tt-label">${actLabel} (A)</span>
    <span class="tt-val">${nA.toFixed(4)}</span></div>`;
  if (nB !== null) {
    html += `<div class="tt-row"><span class="tt-label">${actLabel} (B)</span>
      <span class="tt-val">${nB.toFixed(4)}</span></div>`;
  }

  tt.innerHTML     = html;
  tt.style.display = "block";
  const pad = 12;
  let tx = cx + pad, ty = cy + pad;
  if (tx + 280 > window.innerWidth)  tx = cx - 280 - pad;
  if (ty + 130 > window.innerHeight) ty = cy - 130 - pad;
  tt.style.left = tx + "px";
  tt.style.top  = ty + "px";
}

function hideTooltip() {
  document.getElementById("tooltip").style.display = "none";
}

</script>
</body>
</html>
